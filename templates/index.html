<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Jellyfin ÂΩ±ÁâáÁÆ°ÁêÜ</title>
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <script src="https://unpkg.com/axios/dist/axios.min.js"></script>
    <link rel="stylesheet" href="/static/style.css">
</head>
<body>
    <div id="app">
        <!-- Header -->
        <header>
            <h1>Jellyfin Movies</h1>
            <div class="header-actions">
                <button @click="sync" :disabled="syncing" class="sync-btn">
                    <span v-if="syncing">ÂêåÊ≠•‰∏≠...</span>
                    <span v-else>üîÑ ÂêåÊ≠•</span>
                </button>
                <button @click="calcScores" :disabled="calculating" class="sync-btn score-btn">
                    <span v-if="calculating">ËÆ°ÁÆó‰∏≠...</span>
                    <span v-else>üìä ËÆ°ÁÆóÊùÉÈáçÂàÜ</span>
                </button>
                <span class="stats">ÂÖ± [[ stats.total ]] ÈÉ®ÂΩ±Áâá</span>
            </div>
        </header>

        <!-- Hero Section -->
        <section class="hero-section">
            <div class="hero-content">
                <h2>Jellyfin ÂΩ±ÁâáÂ∫ì</h2>
                <p>ÁÆ°ÁêÜÊÇ®ÁöÑÁßÅ‰∫∫ÂΩ±ÁâáÊî∂ËóèÔºåÊé¢Á¥¢ JavDB Âíå JavLibray Ê¶úÂçï</p>
                <div class="stats-row">
                    <div class="stat-card">
                        <div class="number">[[ stats.total ]]</div>
                        <div class="label">ÈÉ®ÂΩ±Áâá</div>
                    </div>
                    <div class="stat-card">
                        <div class="number">[[ stats.javdb_count || 0 ]]</div>
                        <div class="label">JavDB TOP250</div>
                    </div>
                    <div class="stat-card">
                        <div class="number">[[ stats.javlib_count || 0 ]]</div>
                        <div class="label">JavLibrary TOP500</div>
                    </div>
                </div>
            </div>
        </section>

        <!-- Main Content -->
        <main class="main-content">
            <!-- Tabs -->
            <div class="tabs">
                <button
                    v-for="tab in tabs"
                    :key="tab.id"
                    :class="['tab', { active: currentTab === tab.id }]"
                    @click="switchTab(tab.id)"
                >
                    [[ tab.icon ]] [[ tab.name ]]
                </button>
            </div>

            <!-- Search Bar -->
            <div class="search-bar" v-if="currentTab === 'all' || currentTab.startsWith('actor_')">
                <div class="search-wrapper">
                    <input
                        type="text"
                        v-model="search"
                        placeholder="ÊêúÁ¥¢Áï™Âè∑ÊàñÊºîÂëò..."
                        @input="handleSearch"
                    >
                </div>
                <select v-model="sortBy" @change="handleSearch" class="sort-select">
                    <option value="code">ÊåâÁï™Âè∑ÊéíÂ∫è</option>
                    <option value="year_desc">ÊåâÂπ¥‰ªΩ(Êñ∞‚ÜíÊóß)</option>
                    <option value="year_asc">ÊåâÂπ¥‰ªΩ(Êóß‚ÜíÊñ∞)</option>
                    <option value="score_desc">ÊåâÊùÉÈáçÂàÜ(È´ò‚Üí‰Ωé)</option>
                    <option value="score_asc">ÊåâÊùÉÈáçÂàÜ(‰Ωé‚ÜíÈ´ò)</option>
                </select>
            </div>

            <!-- Movie Cards Grid (All Movies) -->
            <div v-if="currentTab === 'all'" class="movie-list">
                <div class="section-title">ÂÖ®ÈÉ®ÂΩ±Áâá</div>

                <!-- Movie Cards Grid -->
                <div class="movie-grid">
                    <div v-for="movie in movies" :key="movie.code" class="movie-card">
                        <div class="movie-poster">
                            <img v-if="movie.poster_url" :src="movie.poster_url" :alt="movie.title" @error="handlePosterError($event)">
                            <svg v-else class="placeholder-icon" viewBox="0 0 24 24" fill="currentColor">
                                <path d="M18 4l2 4h-3l-2-4h-2l2 4h-3l-2-4H8l2 4H7L5 4H4c-1.1 0-1.99.9-1.99 2L2 18c0 1.1.9 2 2 2h16c1.1 0 2-.9 2-2V4h-4z"/>
                            </svg>
                        </div>
                        <div class="movie-info">
                            <div class="movie-code">[[ movie.code ]]</div>
                            <div class="movie-title" :title="movie.title">[[ movie.title ]]</div>
                            <div class="movie-year">[[ movie.year ]]</div>
                            <div class="movie-score" v-if="movie.score">[[ movie.score ]]ÂàÜ</div>
                            <div class="movie-tags">
                                <span
                                    v-for="tag in movie.all_tags"
                                    :key="tag"
                                    :class="['movie-tag', movie.tags.includes(tag) ? 'active' : 'inactive']"
                                >
                                    [[ getShortTag(tag) ]]
                                </span>
                            </div>
                        </div>
                    </div>
                </div>

                <div v-if="movies.length === 0" class="empty">ÊöÇÊó†Êï∞ÊçÆ</div>

                <!-- Pagination -->
                <div class="pagination" v-if="totalPages > 1">
                    <button @click="goToPage(1)" :disabled="currentPage === 1">È¶ñÈ°µ</button>
                    <button @click="goToPage(currentPage - 1)" :disabled="currentPage === 1">‰∏ä‰∏ÄÈ°µ</button>
                    <span class="page-info">Á¨¨ [[ currentPage ]] / [[ totalPages ]] È°µ (ÂÖ± [[ totalItems ]] Êù°)</span>
                    <button @click="goToPage(currentPage + 1)" :disabled="currentPage === totalPages">‰∏ã‰∏ÄÈ°µ</button>
                    <button @click="goToPage(totalPages)" :disabled="currentPage === totalPages">Êú´È°µ</button>
                    <select v-model="pageSize" @change="changePageSize(pageSize)" class="sort-select" style="padding: 8px 16px;">
                        <option :value="50">50Êù°/È°µ</option>
                        <option :value="100">100Êù°/È°µ</option>
                    </select>
                </div>
            </div>

            <!-- Rank Tables -->
            <div v-else-if="currentTab.startsWith('javdb') || currentTab === 'javlib'" class="rank-section">
                <div class="section-title">[[ getTabTitle(currentTab) ]]</div>

                <div class="rank-table">
                    <table>
                        <thead>
                            <tr>
                                <th>#</th>
                                <th>Áï™Âè∑</th>
                                <th>Ê†áÈ¢ò</th>
                                <th>Âπ¥‰ªΩ</th>
                                <th>ÊºîÂëò</th>
                                <th>Êî∂ÂΩïÁä∂ÊÄÅ</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr v-for="movie in listMovies" :key="movie.code" :class="{ 'not-in-jellyfin': !movie.in_jellyfin }">
                                <td class="rank">[[ movie.rank ]]</td>
                                <td class="code">
                                    <a :href="'https://www.javbus.com/' + movie.code" target="_blank" class="javbus-link">[[ movie.code ]]</a>
                                </td>
                                <td class="title">[[ movie.title || '-' ]]</td>
                                <td>[[ movie.year ]]</td>
                                <td class="actors">[[ movie.actors ]]</td>
                                <td>
                                    <span :class="['status-badge', movie.in_jellyfin ? 'yes' : 'no']">
                                        <span v-if="movie.in_jellyfin">‚úì</span>
                                        <span v-else>‚úó</span>
                                        [[ movie.in_jellyfin ? 'Â∑≤Êî∂ÂΩï' : 'Êú™Êî∂ÂΩï' ]]
                                    </span>
                                    <a v-if="!movie.in_jellyfin" :href="'https://www.javbus.com/' + movie.code" target="_blank" class="javbus-btn">JavBus</a>
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>

                <div class="pagination" v-if="totalPages > 1">
                    <button @click="goToPage(1)" :disabled="currentPage === 1">È¶ñÈ°µ</button>
                    <button @click="goToPage(currentPage - 1)" :disabled="currentPage === 1">‰∏ä‰∏ÄÈ°µ</button>
                    <span class="page-info">Á¨¨ [[ currentPage ]] / [[ totalPages ]] È°µ (ÂÖ± [[ totalItems ]] Êù°)</span>
                    <button @click="goToPage(currentPage + 1)" :disabled="currentPage === totalPages">‰∏ã‰∏ÄÈ°µ</button>
                    <button @click="goToPage(totalPages)" :disabled="currentPage === totalPages">Êú´È°µ</button>
                    <select v-model="pageSize" @change="changePageSize(pageSize)" class="sort-select" style="padding: 8px 16px;">
                        <option :value="50">50Êù°/È°µ</option>
                        <option :value="100">100Êù°/È°µ</option>
                    </select>
                </div>
            </div>

            <!-- Missing View -->
            <div v-else-if="currentTab === 'missing'" class="missing-view">
                <div v-if="missing.both && missing.both.length > 0" class="missing-section both-section">
                    <h2>‚ö†Ô∏è ‰∏§Ê¶úÂçïÂùáÊú™Êî∂ÂΩï ([[ missing.both.length ]])</h2>
                    <div class="code-list">
                        <span v-for="code in missing.both" :key="code" class="code-item code-item-both">
                            <a :href="'https://www.javbus.com/' + code" target="_blank" class="javbus-link">[[ code ]]</a>
                        </span>
                    </div>
                </div>

                <div class="missing-tables">
                    <div class="missing-section">
                        <h2>JavDB TOP250 Êú™Êî∂ÂΩï ([[ missing.javdb ? missing.javdb.length : 0 ]])</h2>
                        <div class="rank-table">
                            <table>
                                <thead>
                                    <tr>
                                        <th>#</th>
                                        <th>Áï™Âè∑</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <tr v-for="item in missing.javdb" :key="item.code" :class="{ 'in-both': missing.both && missing.both.includes(item.code) }">
                                        <td class="rank">[[ item.rank ]]</td>
                                        <td class="code">
                                            <a :href="'https://www.javbus.com/' + item.code" target="_blank" class="javbus-link">[[ item.code ]]</a>
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                    <div class="missing-section">
                        <h2>JavLibray TOP500 Êú™Êî∂ÂΩï ([[ missing.javlib ? missing.javlib.length : 0 ]])</h2>
                        <div class="rank-table">
                            <table>
                                <thead>
                                    <tr>
                                        <th>#</th>
                                        <th>Áï™Âè∑</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <tr v-for="item in missing.javlib" :key="item.code" :class="{ 'in-both': missing.both && missing.both.includes(item.code) }">
                                        <td class="rank">[[ item.rank ]]</td>
                                        <td class="code">
                                            <a :href="'https://www.javbus.com/' + item.code" target="_blank" class="javbus-link">[[ item.code ]]</a>
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Actors List -->
            <div v-else-if="currentTab === 'actors'" class="actors-view">
                <div class="section-title">ÊºîÂëòÂàóË°®</div>
                <div class="actor-list">
                    <div
                        v-for="actor in actors"
                        :key="actor.name"
                        :class="['actor-item', { 'has-javbus': rssActors[actor.name] && rssActors[actor.name].javbus_id }]"
                        @click="showActorDetail(actor.name)"
                    >
                        <span class="actor-name">[[ actor.name ]]</span>
                        <span class="actor-count">[[ actor.count ]] ÈÉ®</span>
                        <span v-if="rssActors[actor.name] && rssActors[actor.name].javbus_id" class="javbus-badge">üì°</span>
                    </div>
                </div>
            </div>

            <!-- Actor Detail Page -->
            <div v-else-if="currentTab.startsWith('actor_')" class="actor-detail-page">
                <!-- Back button and header -->
                <button class="back-btn" @click="currentTab = 'actors'; loadActors()">‚Üê ËøîÂõûÊºîÂëòÂàóË°®</button>

                <!-- Actor Profile -->
                <div class="actor-profile">
                    <div class="actor-avatar">
                        <img v-if="actorDetail.avatar_url" :src="actorDetail.avatar_url" :alt="actorDetail.name" @error="handleActorAvatarError($event)">
                        <svg v-else class="avatar-placeholder" viewBox="0 0 24 24" fill="currentColor">
                            <path d="M12 12c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm0 2c-2.67 0-8 1.34-8 4v2h16v-2c0-2.66-5.33-4-8-4z"/>
                        </svg>
                    </div>
                    <div class="actor-info-section">
                        <h2 class="actor-name">[[ actorDetail.name ]]</h2>
                        <div class="actor-stats">
                            <div class="stat-item">
                                <span class="stat-label">ÂΩ±Áâá</span>
                                <span class="stat-value">[[ actorDetail.movie_count ]] ÈÉ®</span>
                            </div>
                            <div class="stat-item" v-if="actorDetail.last_updated">
                                <span class="stat-label">RSSÊõ¥Êñ∞</span>
                                <span class="stat-value">[[ formatDate(actorDetail.last_updated) ]]</span>
                            </div>
                        </div>
                        <div class="javbus-config">
                            <label>JAVBus ID:</label>
                            <input
                                type="text"
                                v-model="actorDetail.javbus_id"
                                placeholder="ËæìÂÖ•JAVBus ID"
                                class="javbus-input-large"
                            >
                            <button @click="saveActorJavbusId" class="rss-refresh-small save-btn">
                                üíæ ‰øùÂ≠ò
                            </button>
                            <button v-if="actorDetail.javbus_id" @click="refreshActorRss" :disabled="rssRefreshing" class="rss-refresh-small">
                                [[ rssRefreshing ? 'Âà∑Êñ∞‰∏≠' : 'üîÑ Âà∑Êñ∞' ]]
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Tabs for Actor Detail -->
                <div class="actor-tabs">
                    <button
                        :class="['actor-tab', { active: actorSubTab === 'movies' }]"
                        @click="actorSubTab = 'movies'"
                    >
                        ÂÖ®ÈÉ®ÂΩ±Áâá
                    </button>
                    <button
                        :class="['actor-tab', { active: actorSubTab === 'rss' }]"
                        @click="actorSubTab = 'rss'; loadActorRssItems()"
                    >
                        RSSËÆ¢ÈòÖ <span v-if="actorRssUnwatched > 0" class="unwatched-badge">[[ actorRssUnwatched ]]</span>
                    </button>
                </div>

                <!-- Movies Tab -->
                <div v-if="actorSubTab === 'movies'" class="actor-movies">
                    <div class="movie-grid">
                        <div v-for="movie in actorMovies" :key="movie.code" class="movie-card">
                            <div class="movie-poster">
                                <img v-if="movie.poster_url" :src="movie.poster_url" :alt="movie.title" @error="handlePosterError($event)">
                                <svg v-else class="placeholder-icon" viewBox="0 0 24 24" fill="currentColor">
                                    <path d="M18 4l2 4h-3l-2-4h-2l2 4h-3l-2-4H8l2 4H7L5 4H4c-1.1 0-1.99.9-1.99 2L2 18c0 1.1.9 2 2 2h16c1.1 0 2-.9 2-2V4h-4z"/>
                                </svg>
                            </div>
                            <div class="movie-info">
                                <div class="movie-code">[[ movie.code ]]</div>
                                <div class="movie-title" :title="movie.title">[[ movie.title ]]</div>
                                <div class="movie-year">[[ movie.year ]]</div>
                                <div class="movie-score" v-if="movie.score">[[ movie.score ]]ÂàÜ</div>
                                <div class="movie-tags">
                                    <span
                                        v-for="tag in movie.all_tags"
                                        :key="tag"
                                        :class="['movie-tag', movie.tags.includes(tag) ? 'active' : 'inactive']"
                                    >
                                        [[ getShortTag(tag) ]]
                                    </span>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div v-if="actorMovies.length === 0" class="empty">ÊöÇÊó†ÂΩ±Áâá</div>
                </div>

                <!-- RSS Tab -->
                <div v-if="actorSubTab === 'rss'" class="actor-rss-list">
                    <div class="rss-actions" v-if="actorRssItems.length > 0">
                        <button @click="markActorWatched(actorDetail.actor_id)" class="watched-btn">
                            ‚úì ‰∏ÄÈîÆÂ∑≤ÈòÖ
                        </button>
                    </div>
                    <div v-if="actorRssItems.length === 0" class="empty">ÊöÇÊó†RSSËÆ¢ÈòÖÊï∞ÊçÆ</div>
                    <div v-for="item in actorRssItems" :key="item.id" :class="['rss-item', { watched: item.is_watched }]">
                        <input
                            type="checkbox"
                            :checked="item.is_watched"
                            @change="toggleWatch(item.id, $event.target.checked)"
                            class="rss-checkbox"
                        >
                        <div class="rss-item-content">
                            <div class="rss-item-header">
                                <a :href="item.javbus_url" target="_blank" class="rss-code">[[ item.code ]]</a>
                                <span class="rss-score" :title="'ÊùÉÈáçÂàÜ: ' + item.score">[[ item.score ]]ÂàÜ</span>
                            </div>
                            <div class="rss-item-title" :title="item.title">[[ item.title ]]</div>
                            <div class="rss-item-date">[[ item.pub_date ]]</div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- RSS Subscription View -->
            <div v-else-if="currentTab === 'rss'" class="rss-view">
                <div class="rss-header">
                    <div class="section-title">RSS ËÆ¢ÈòÖ</div>
                    <div class="rss-actions">
                        <button @click="refreshRss" :disabled="rssRefreshing" class="rss-refresh-btn">
                            [[ rssRefreshing ? 'Âà∑Êñ∞‰∏≠...' : 'üîÑ Âà∑Êñ∞ÂÖ®ÈÉ®' ]]
                        </button>
                        <button @click="markAllWatched" :disabled="rssItems.length === 0" class="watched-btn">
                            ‚úì ‰∏ÄÈîÆÂ∑≤ÈòÖ
                        </button>
                    </div>
                </div>

                <!-- View Toggle -->
                <div class="rss-view-toggle">
                    <button :class="['toggle-btn', { active: rssViewMode === 'all' }]" @click="rssViewMode = 'all'">
                        ÊÄªÂàóË°®
                    </button>
                    <button :class="['toggle-btn', { active: rssViewMode === 'by_actor' }]" @click="rssViewMode = 'by_actor'">
                        ÊåâÊºîÂëò
                    </button>
                </div>

                <!-- RSS Items List (All Mode) -->
                <div v-if="rssViewMode === 'all'" class="rss-list">
                    <div v-if="rssItems.length === 0" class="empty">ÊöÇÊó†ËÆ¢ÈòÖÊï∞ÊçÆ</div>
                    <div v-for="item in rssItems" :key="item.id" :class="['rss-item', { watched: item.is_watched }]">
                        <input
                            type="checkbox"
                            :checked="item.is_watched"
                            @change="toggleWatch(item.id, $event.target.checked)"
                            class="rss-checkbox"
                        >
                        <div class="rss-item-content">
                            <div class="rss-item-header">
                                <a :href="item.javbus_url" target="_blank" class="rss-code">[[ item.code ]]</a>
                                <span class="rss-score" :title="'ÊùÉÈáçÂàÜ: ' + item.score">[[ item.score ]]ÂàÜ</span>
                                <span class="rss-actor">[[ item.actor_name ]]</span>
                            </div>
                            <div class="rss-item-title" :title="item.title">[[ item.title ]]</div>
                            <div class="rss-item-date">[[ item.pub_date ]]</div>
                        </div>
                    </div>
                </div>

                <!-- RSS Items List (By Actor Mode) -->
                <div v-else class="rss-by-actor">
                    <div v-for="(items, actorName) in rssItemsByActor" :key="actorName" class="actor-rss-group">
                        <h3 class="actor-rss-title">
                            <span class="collapse-toggle" @click="collapsedActors[actorName] = !collapsedActors[actorName]">
                                [[ collapsedActors[actorName] ? '‚ñ∂' : '‚ñº' ]]
                            </span>
                            [[ actorName ]] ([[ items.length ]] ÈÉ®)
                            <button @click="markActorWatched(items[0].actor_id)" class="small-watched-btn">
                                ‰∏ÄÈîÆÂ∑≤ÈòÖ
                            </button>
                        </h3>
                        <div v-show="!collapsedActors[actorName]" class="rss-list">
                            <div v-for="item in items" :key="item.id" :class="['rss-item', { watched: item.is_watched }]">
                                <input
                                    type="checkbox"
                                    :checked="item.is_watched"
                                    @change="toggleWatch(item.id, $event.target.checked)"
                                    class="rss-checkbox"
                                >
                                <div class="rss-item-content">
                                    <div class="rss-item-header">
                                        <a :href="item.javbus_url" target="_blank" class="rss-code">[[ item.code ]]</a>
                                        <span class="rss-score" :title="'ÊùÉÈáçÂàÜ: ' + item.score">[[ item.score ]]ÂàÜ</span>
                                    </div>
                                    <div class="rss-item-title" :title="item.title">[[ item.title ]]</div>
                                    <div class="rss-item-date">[[ item.pub_date ]]</div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div v-if="Object.keys(rssItemsByActor).length === 0" class="empty">ÊöÇÊó†ËÆ¢ÈòÖÊï∞ÊçÆ</div>
                </div>
            </div>
        </main>
    </div>

    <script>
        const { createApp, ref, onMounted, watch } = Vue;

        const app = createApp({
            setup() {
                const currentTab = ref('all');
                const movies = ref([]);
                const listMovies = ref([]);
                const missing = ref({ javdb: [], javlib: [], both: [] });
                const actors = ref([]);
                const actorMovies = ref([]);
                const currentActorName = ref('');
                const search = ref('');
                const sortBy = ref('code');
                const syncing = ref(false);
                const calculating = ref(false);
                const stats = ref({ total: 0, javdb_count: 0, javlib_count: 0 });

                // RSS
                const rssItems = ref([]);
                const rssItemsByActor = ref({});
                const rssViewMode = ref('all');
                const rssRefreshing = ref(false);
                const rssActors = ref({});  // {name: {javbus_id, id}}
                const currentRssActorId = ref(null);
                const collapsedActors = ref({});  // Track collapsed state for each actor

                // Actor detail page
                const actorDetail = ref({
                    name: '',
                    javbus_id: '',
                    rss_url: '',
                    last_updated: '',
                    movie_count: 0,
                    avatar_url: '',
                    actor_id: null
                });
                const actorSubTab = ref('movies');
                const actorRssItems = ref([]);
                const actorRssUnwatched = ref(0);

                // Pagination
                const currentPage = ref(1);
                const pageSize = ref(50);
                const totalPages = ref(1);
                const totalItems = ref(0);

                const tabs = [
                    { id: 'all', name: 'ÂÖ®ÈÉ®', icon: 'üìö' },
                    { id: 'actors', name: 'ÊºîÂëò', icon: 'üë§' },
                    { id: 'rss', name: 'RSSËÆ¢ÈòÖ', icon: 'üì°' },
                    { id: 'javdb', name: 'JavDB TOP250', icon: 'üèÜ' },
                    { id: 'javdb_2025', name: 'JavDB 2025', icon: 'üèÜ' },
                    { id: 'javdb_2024', name: 'JavDB 2024', icon: 'üèÜ' },
                    { id: 'javdb_2023', name: 'JavDB 2023', icon: 'üèÜ' },
                    { id: 'javlib', name: 'JavLibray TOP500', icon: 'üèÜ' },
                    { id: 'missing', name: 'Êú™Êî∂ÂΩï', icon: '‚ùå' }
                ];

                const getShortTag = (tag) => {
                    const map = {
                        'JavDB TOP250': 'DB',
                        'JavDB 2025 TOP250': 'DB25',
                        'JavDB 2024 TOP250': 'DB24',
                        'JavDB 2023 TOP250': 'DB23',
                        'JavLibray TOP500': 'JL'
                    };
                    return map[tag] || tag;
                };

                // Handle poster image load error - show placeholder
                const handlePosterError = (event) => {
                    event.target.style.display = 'none';
                    const placeholder = event.target.nextElementSibling;
                    if (placeholder) {
                        placeholder.style.display = 'block';
                    }
                };

                const getTabTitle = (tabId) => {
                    const tab = tabs.find(t => t.id === tabId);
                    return tab ? tab.name : '';
                };

                const sortMovies = (list) => {
                    if (sortBy.value === 'year_desc') {
                        return [...list].sort((a, b) => (b.year || '').localeCompare(a.year || ''));
                    } else if (sortBy.value === 'year_asc') {
                        return [...list].sort((a, b) => (a.year || '').localeCompare(b.year || ''));
                    } else if (sortBy.value === 'score_desc') {
                        return [...list].sort((a, b) => (b.score || 0) - (a.score || 0));
                    } else if (sortBy.value === 'score_asc') {
                        return [...list].sort((a, b) => (a.score || 0) - (b.score || 0));
                    }
                    return list;
                };

                const loadMovies = async () => {
                    const res = await axios.get('/api/movies', {
                        params: {
                            search: search.value,
                            page: currentPage.value,
                            page_size: pageSize.value
                        }
                    });
                    movies.value = sortMovies(res.data.data);
                    totalPages.value = res.data.total_pages;
                    totalItems.value = res.data.total;
                };

                const handleSearch = () => {
                    currentPage.value = 1;
                    if (currentTab.value === 'all') {
                        loadMovies();
                    } else if (currentTab.value.startsWith('actor_')) {
                        sortActorMovies();
                    }
                };

                const sortActorMovies = () => {
                    actorMovies.value = sortMovies(actorMovies.value);
                };

                const loadList = async (listName) => {
                    let apiName = listName;
                    if (listName === 'javdb') apiName = 'JavDB TOP250';
                    if (listName === 'javdb_2025') apiName = 'JavDB 2025 TOP250';
                    if (listName === 'javdb_2024') apiName = 'JavDB 2024 TOP250';
                    if (listName === 'javdb_2023') apiName = 'JavDB 2023 TOP250';
                    if (listName === 'javlib') apiName = 'JavLibray TOP500';

                    const res = await axios.get(`/api/list/${encodeURIComponent(apiName)}`, {
                        params: {
                            page: currentPage.value,
                            page_size: pageSize.value
                        }
                    });
                    listMovies.value = res.data.data;
                    totalPages.value = res.data.total_pages;
                    totalItems.value = res.data.total;
                };

                const loadMissing = async () => {
                    const res = await axios.get('/api/list/missing');
                    missing.value = res.data;
                };

                const loadActors = async () => {
                    const res = await axios.get('/api/actors');
                    actors.value = res.data;
                };

                const showActorMovies = async (actorName) => {
                    currentActorName.value = actorName;
                    const res = await axios.get(`/api/actor/${encodeURIComponent(actorName)}`);
                    actorMovies.value = sortMovies(res.data);
                    currentTab.value = 'actor_' + encodeURIComponent(actorName);
                };

                const showActorDetail = async (actorName) => {
                    currentActorName.value = actorName;
                    actorSubTab.value = 'movies';

                    // Load actor detail
                    const detailRes = await axios.get(`/api/actor/${encodeURIComponent(actorName)}/detail`);
                    actorDetail.value = detailRes.data;

                    // Load actor movies
                    const moviesRes = await axios.get(`/api/actor/${encodeURIComponent(actorName)}`);
                    actorMovies.value = sortMovies(moviesRes.data);

                    currentTab.value = 'actor_' + encodeURIComponent(actorName);
                };

                const saveActorJavbusId = async () => {
                    if (!actorDetail.value.actor_id) return;

                    await axios.put(`/api/rss/actors/${actorDetail.value.actor_id}`, {
                        javbus_id: actorDetail.value.javbus_id
                    });
                };

                const refreshActorRss = async () => {
                    if (!actorDetail.value.actor_id) return;

                    rssRefreshing.value = true;
                    try {
                        // Only refresh current actor's RSS
                        await axios.post(`/api/rss/refresh/${actorDetail.value.actor_id}`);
                        // Reload actor detail to get updated last_updated
                        const detailRes = await axios.get(`/api/actor/${encodeURIComponent(actorDetail.value.name)}/detail`);
                        actorDetail.value = detailRes.data;

                        // Reload RSS items if on RSS tab
                        if (actorSubTab.value === 'rss') {
                            await loadActorRssItems();
                        }
                    } finally {
                        rssRefreshing.value = false;
                    }
                };

                const loadActorRssItems = async () => {
                    if (!actorDetail.value.actor_id) return;

                    const res = await axios.get('/api/rss/items', {
                        params: { actor_id: actorDetail.value.actor_id }
                    });
                    actorRssItems.value = res.data;
                    actorRssUnwatched.value = res.data.filter(item => !item.is_watched).length;
                };

                const formatDate = (dateStr) => {
                    if (!dateStr) return '-';
                    try {
                        const date = new Date(dateStr);
                        return date.toLocaleDateString('zh-CN');
                    } catch {
                        return dateStr;
                    }
                };

                const handleActorAvatarError = (event) => {
                    event.target.style.display = 'none';
                    const placeholder = event.target.nextElementSibling;
                    if (placeholder) {
                        placeholder.style.display = 'block';
                    }
                };

                const loadStats = async () => {
                    const res = await axios.get('/api/stats');
                    stats.value = res.data;
                };

                const loadRssItems = async () => {
                    const view = rssViewMode.value;
                    const params = { view };
                    if (currentRssActorId.value) {
                        params.actor_id = currentRssActorId.value;
                    }
                    const res = await axios.get('/api/rss/items', { params });
                    if (view === 'by_actor') {
                        rssItemsByActor.value = res.data;
                    } else {
                        rssItems.value = res.data;
                    }
                };

                const refreshRss = async () => {
                    rssRefreshing.value = true;
                    try {
                        await axios.post('/api/rss/refresh');
                        await loadRssItems();
                    } finally {
                        rssRefreshing.value = false;
                    }
                };

                const toggleWatch = async (itemId, isWatched) => {
                    await axios.post(`/api/rss/items/${itemId}/watch`, { is_watched: isWatched });
                    await loadRssItems();
                };

                const markAllWatched = async () => {
                    await axios.post('/api/rss/items/watch', {});
                    await loadRssItems();
                };

                const markActorWatched = async (actorId) => {
                    await axios.post('/api/rss/items/watch', { actor_id: actorId });
                    await loadRssItems();
                };

                const loadRssActors = async () => {
                    const res = await axios.get('/api/rss/actors');
                    const actorsMap = {};
                    for (const actor of res.data) {
                        actorsMap[actor.name] = {
                            javbus_id: actor.javbus_id,
                            id: actor.id,
                            has_rss: actor.has_rss
                        };
                    }
                    rssActors.value = actorsMap;
                };

                const updateActorJavbusId = async (actorName, javbusId) => {
                    // Find or create the actor in the database
                    let actorData = rssActors.value[actorName];
                    if (!actorData) {
                        // Create the actor first
                        await axios.post('/api/rss/actors', { name: actorName });
                        await loadRssActors();
                        actorData = rssActors.value[actorName];
                    }

                    if (actorData && actorData.id) {
                        await axios.put(`/api/rss/actors/${actorData.id}`, { javbus_id: javbusId });
                        await loadRssActors();
                    }
                };

                const showActorRss = async (actorName) => {
                    const actorData = rssActors.value[actorName];
                    if (actorData && actorData.id) {
                        currentRssActorId.value = actorData.id;
                        currentTab.value = 'rss';
                        await loadRssItems();
                    }
                };

                const sync = async () => {
                    syncing.value = true;
                    try {
                        await axios.post('/api/sync');
                        await loadMovies();
                        await loadStats();
                        await switchTab(currentTab.value);
                    } finally {
                        syncing.value = false;
                    }
                };

                const calcScores = async () => {
                    calculating.value = true;
                    try {
                        await axios.post('/api/calc_scores');
                        await loadMovies();
                        alert('ÊùÉÈáçÂàÜËÆ°ÁÆóÂÆåÊàêÔºÅ');
                    } finally {
                        calculating.value = false;
                    }
                };

                const switchTab = async (tabId) => {
                    currentTab.value = tabId;
                    currentPage.value = 1;
                    if (tabId === 'all') {
                        await loadMovies();
                    } else if (tabId === 'missing') {
                        await loadMissing();
                    } else if (tabId === 'actors') {
                        await loadActors();
                        await loadRssActors();
                    } else if (tabId === 'rss') {
                        await loadRssItems();
                    } else if (tabId.startsWith('actor_')) {
                        const actorName = decodeURIComponent(tabId.substring(7));
                        currentActorName.value = actorName;
                        // Load actor detail
                        const detailRes = await axios.get(`/api/actor/${encodeURIComponent(actorName)}/detail`);
                        actorDetail.value = detailRes.data;
                        // Load actor movies
                        const res = await axios.get(`/api/actor/${encodeURIComponent(actorName)}`);
                        actorMovies.value = sortMovies(res.data);
                        actorSubTab.value = 'movies';
                    } else {
                        await loadList(tabId);
                    }
                };

                const goToPage = async (page) => {
                    if (page < 1 || page > totalPages.value) return;
                    currentPage.value = page;
                    if (currentTab.value === 'all') {
                        await loadMovies();
                    } else if (currentTab.value.startsWith('javdb') || currentTab.value === 'javlib') {
                        await loadList(currentTab.value);
                    }
                };

                const changePageSize = async (size) => {
                    pageSize.value = size;
                    currentPage.value = 1;
                    if (currentTab.value === 'all') {
                        await loadMovies();
                    } else if (currentTab.value.startsWith('javdb') || currentTab.value === 'javlib') {
                        await loadList(currentTab.value);
                    }
                };

                onMounted(async () => {
                    await loadStats();
                    await switchTab('all');
                });

                // Watch for RSS view mode changes
                watch(rssViewMode, async () => {
                    if (currentTab.value === 'rss') {
                        await loadRssItems();
                    }
                });

                return {
                    currentTab,
                    movies,
                    listMovies,
                    missing,
                    actors,
                    actorMovies,
                    currentActorName,
                    search,
                    sortBy,
                    syncing,
                    calculating,
                    stats,
                    tabs,
                    currentPage,
                    pageSize,
                    totalPages,
                    totalItems,
                    // RSS
                    rssItems,
                    rssItemsByActor,
                    rssViewMode,
                    rssRefreshing,
                    rssActors,
                    currentRssActorId,
                    collapsedActors,
                    // Actor detail
                    actorDetail,
                    actorSubTab,
                    actorRssItems,
                    actorRssUnwatched,
                    getShortTag,
                    getTabTitle,
                    loadMovies,
                    handleSearch,
                    loadActors,
                    showActorMovies,
                    showActorDetail,
                    sync,
                    calcScores,
                    switchTab,
                    goToPage,
                    changePageSize,
                    handlePosterError,
                    loadRssItems,
                    refreshRss,
                    toggleWatch,
                    markAllWatched,
                    markActorWatched,
                    loadRssActors,
                    updateActorJavbusId,
                    showActorRss,
                    saveActorJavbusId,
                    refreshActorRss,
                    loadActorRssItems,
                    formatDate,
                    handleActorAvatarError
                };
            }
        });

        app.config.compilerOptions.delimiters = ['[[', ']]'];
        app.mount('#app');
    </script>
</body>
</html>
