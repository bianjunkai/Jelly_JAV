<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Jellyfin ÂΩ±ÁâáÁÆ°ÁêÜ</title>
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <script src="https://unpkg.com/axios/dist/axios.min.js"></script>
    <link rel="stylesheet" href="/static/style.css">
</head>
<body>
    <div id="app">
        <header>
            <h1>üé¨ Jellyfin ÂΩ±ÁâáÁÆ°ÁêÜ</h1>
            <div class="header-actions">
                <button @click="sync" :disabled="syncing" class="sync-btn">
                    <span v-if="syncing">ÂêåÊ≠•‰∏≠...</span>
                    <span v-else>üîÑ ÂêåÊ≠• Jellyfin</span>
                </button>
                <span class="stats">ÂÖ± [[ stats.total ]] ÈÉ®ÂΩ±Áâá</span>
            </div>
        </header>

        <div class="tabs">
            <button 
                v-for="tab in tabs" 
                :key="tab.id"
                :class="['tab', { active: currentTab === tab.id }]"
                @click="switchTab(tab.id)"
            >
                [[ tab.icon ]] [[ tab.name ]]
            </button>
        </div>

        <div class="search-bar" v-if="currentTab === 'all' || currentTab.startsWith('actor_')">
            <input 
                type="text" 
                v-model="search" 
                placeholder="ÊêúÁ¥¢Áï™Âè∑ÊàñÊºîÂëò..."
                @input="handleSearch"
            >
            <select v-model="sortBy" @change="handleSearch" class="sort-select">
                <option value="code">ÊåâÁï™Âè∑ÊéíÂ∫è</option>
                <option value="year_desc">ÊåâÂπ¥‰ªΩ(Êñ∞‚ÜíÊóß)</option>
                <option value="year_asc">ÊåâÂπ¥‰ªΩ(Êóß‚ÜíÊñ∞)</option>
            </select>
        </div>

        <div class="content">
            <!-- ÂÖ®ÈÉ®ÂΩ±Áâá -->
            <div v-if="currentTab === 'all'" class="movie-list">
                <table>
                    <thead>
                        <tr>
                            <th>Áï™Âè∑</th>
                            <th>Ê†áÈ¢ò</th>
                            <th>Âπ¥‰ªΩ</th>
                            <th>ÊºîÂëò</th>
                            <th>‰∏äÊ¶úÊÉÖÂÜµ</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr v-for="movie in movies" :key="movie.code">
                            <td class="code">[[ movie.code ]]</td>
                            <td class="title">[[ movie.title ]]</td>
                            <td>[[ movie.year ]]</td>
                            <td class="actors">[[ movie.actors ]]</td>
                            <td class="tags">
                                <span
                                    v-for="tag in movie.all_tags"
                                    :key="tag"
                                    :class="['tag', movie.tags.includes(tag) ? 'tag-active' : 'tag-inactive']"
                                >
                                    [[ getShortTag(tag) ]]
                                </span>
                            </td>
                        </tr>
                    </tbody>
                </table>
                <div v-if="movies.length === 0" class="empty">ÊöÇÊó†Êï∞ÊçÆ</div>
                <div class="pagination" v-if="totalPages > 1">
                    <button @click="goToPage(1)" :disabled="currentPage === 1">È¶ñÈ°µ</button>
                    <button @click="goToPage(currentPage - 1)" :disabled="currentPage === 1">‰∏ä‰∏ÄÈ°µ</button>
                    <span class="page-info">Á¨¨ [[ currentPage ]] / [[ totalPages ]] È°µ (ÂÖ± [[ totalItems ]] Êù°)</span>
                    <button @click="goToPage(currentPage + 1)" :disabled="currentPage === totalPages">‰∏ã‰∏ÄÈ°µ</button>
                    <button @click="goToPage(totalPages)" :disabled="currentPage === totalPages">Êú´È°µ</button>
                    <select v-model="pageSize" @change="changePageSize(pageSize)" class="page-size-select">
                        <option :value="50">50Êù°/È°µ</option>
                        <option :value="100">100Êù°/È°µ</option>
                    </select>
                </div>
            </div>

            <!-- Ê¶úÂçïËßÜÂõæ -->
            <div v-else-if="currentTab.startsWith('javdb') || currentTab === 'javlib'" class="movie-list">
                <table>
                    <thead>
                        <tr>
                            <th>#</th>
                            <th>Áï™Âè∑</th>
                            <th>Ê†áÈ¢ò</th>
                            <th>Âπ¥‰ªΩ</th>
                            <th>ÊºîÂëò</th>
                            <th>Jellyfin Êî∂ÂΩï</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr v-for="movie in listMovies" :key="movie.code" :class="{ 'not-in-jellyfin': !movie.in_jellyfin }">
                            <td class="rank">[[ movie.rank ]]</td>
                            <td class="code">
                                <a :href="'https://www.javbus.com/' + movie.code" target="_blank" class="javbus-link">[[ movie.code ]]</a>
                            </td>
                            <td class="title">[[ movie.title || '-' ]]</td>
                            <td>[[ movie.year ]]</td>
                            <td class="actors">[[ movie.actors ]]</td>
                            <td>
                                <span :class="['status', movie.in_jellyfin ? 'status-yes' : 'status-no']">
                                    [[ movie.in_jellyfin ? '‚úì Â∑≤Êî∂ÂΩï' : '‚úó Êú™Êî∂ÂΩï' ]]
                                </span>
                                <a v-if="!movie.in_jellyfin" :href="'https://www.javbus.com/' + movie.code" target="_blank" class="javbus-btn">JavBus</a>
                            </td>
                        </tr>
                    </tbody>
                </table>
                <div class="pagination" v-if="totalPages > 1">
                    <button @click="goToPage(1)" :disabled="currentPage === 1">È¶ñÈ°µ</button>
                    <button @click="goToPage(currentPage - 1)" :disabled="currentPage === 1">‰∏ä‰∏ÄÈ°µ</button>
                    <span class="page-info">Á¨¨ [[ currentPage ]] / [[ totalPages ]] È°µ (ÂÖ± [[ totalItems ]] Êù°)</span>
                    <button @click="goToPage(currentPage + 1)" :disabled="currentPage === totalPages">‰∏ã‰∏ÄÈ°µ</button>
                    <button @click="goToPage(totalPages)" :disabled="currentPage === totalPages">Êú´È°µ</button>
                    <select v-model="pageSize" @change="changePageSize(pageSize)" class="page-size-select">
                        <option :value="50">50Êù°/È°µ</option>
                        <option :value="100">100Êù°/È°µ</option>
                    </select>
                </div>
            </div>

            <!-- Êú™Êî∂ÂΩï -->
            <div v-else-if="currentTab === 'missing'" class="missing-view">
                <!-- ‰∏§Ê¶úÂçïÂùáÊú™Êî∂ÂΩï -->
                <div v-if="missing.both.length > 0" class="missing-section both-section">
                    <h2>‚ö†Ô∏è ‰∏§Ê¶úÂçïÂùáÊú™Êî∂ÂΩï ([[ missing.both.length ]])</h2>
                    <div class="code-list">
                        <span v-for="code in missing.both" :key="code" class="code-item code-item-both">
                            <a :href="'https://www.javbus.com/' + code" target="_blank" class="javbus-link">[[ code ]]</a>
                        </span>
                    </div>
                </div>

                <!-- ‰∏§‰∏™Ê¶úÂçïÂπ∂Êéí -->
                <div class="missing-tables">
                    <div class="missing-section">
                        <h2>JavDB TOP250 Êú™Êî∂ÂΩï ([[ missing.javdb.length ]])</h2>
                        <table>
                            <thead>
                                <tr>
                                    <th>#</th>
                                    <th>Áï™Âè∑</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr v-for="item in missing.javdb" :key="item.code" :class="{ 'in-both': missing.both.includes(item.code) }">
                                    <td class="rank">[[ item.rank ]]</td>
                                    <td class="code">
                                        <a :href="'https://www.javbus.com/' + item.code" target="_blank" class="javbus-link">[[ item.code ]]</a>
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                    <div class="missing-section">
                        <h2>JavLibray TOP500 Êú™Êî∂ÂΩï ([[ missing.javlib.length ]])</h2>
                        <table>
                            <thead>
                                <tr>
                                    <th>#</th>
                                    <th>Áï™Âè∑</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr v-for="item in missing.javlib" :key="item.code" :class="{ 'in-both': missing.both.includes(item.code) }">
                                    <td class="rank">[[ item.rank ]]</td>
                                    <td class="code">
                                        <a :href="'https://www.javbus.com/' + item.code" target="_blank" class="javbus-link">[[ item.code ]]</a>
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- ÊºîÂëòÂàóË°® -->
            <div v-else-if="currentTab === 'actors'" class="actors-view">
                <div class="actor-list">
                    <div 
                        v-for="actor in actors" 
                        :key="actor.name" 
                        class="actor-item"
                        @click="showActorMovies(actor.name)"
                    >
                        <span class="actor-name">[[ actor.name ]]</span>
                        <span class="actor-count">[[ actor.count ]] ÈÉ®</span>
                    </div>
                </div>
            </div>

            <!-- ÊºîÂëòËØ¶ÊÉÖ -->
            <div v-else-if="currentTab.startsWith('actor_')" class="actor-detail">
                <button class="back-btn" @click="currentTab = 'actors'; loadActors()">‚Üê ËøîÂõûÊºîÂëòÂàóË°®</button>
                <h2>[[ currentActorName ]] ÁöÑÂΩ±Áâá ([[ actorMovies.length ]] ÈÉ®)</h2>
                <table>
                    <thead>
                        <tr>
                            <th>Áï™Âè∑</th>
                            <th>Ê†áÈ¢ò</th>
                            <th>Âπ¥‰ªΩ</th>
                            <th>ÊºîÂëò</th>
                            <th>‰∏äÊ¶úÊÉÖÂÜµ</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr v-for="movie in actorMovies" :key="movie.code">
                            <td class="code">[[ movie.code ]]</td>
                            <td class="title">[[ movie.title ]]</td>
                            <td>[[ movie.year ]]</td>
                            <td class="actors">[[ movie.actors ]]</td>
                            <td class="tags">
                                <span 
                                    v-for="tag in movie.all_tags" 
                                    :key="tag"
                                    :class="['tag', movie.tags.includes(tag) ? 'tag-active' : 'tag-inactive']"
                                >
                                    [[ getShortTag(tag) ]]
                                </span>
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <script>
        const { createApp, ref, onMounted } = Vue;

        const app = createApp({
            setup() {
                const currentTab = ref('all');
                const movies = ref([]);
                const listMovies = ref([]);
                const missing = ref({ javdb: [], javlib: [] });
                const actors = ref([]);
                const actorMovies = ref([]);
                const currentActorName = ref('');
                const search = ref('');
                const sortBy = ref('code');
                const syncing = ref(false);
                const stats = ref({ total: 0 });

                // ÂàÜÈ°µÁä∂ÊÄÅ
                const currentPage = ref(1);
                const pageSize = ref(50);
                const totalPages = ref(1);
                const totalItems = ref(0);

                const tabs = [
                    { id: 'all', name: 'ÂÖ®ÈÉ®', icon: 'üìö' },
                    { id: 'actors', name: 'ÊºîÂëò', icon: 'üë§' },
                    { id: 'javdb', name: 'JavDB TOP250', icon: 'üèÜ' },
                    { id: 'javdb_2025', name: 'JavDB 2025', icon: 'üèÜ' },
                    { id: 'javdb_2024', name: 'JavDB 2024', icon: 'üèÜ' },
                    { id: 'javdb_2023', name: 'JavDB 2023', icon: 'üèÜ' },
                    { id: 'javlib', name: 'JavLibray TOP500', icon: 'üèÜ' },
                    { id: 'missing', name: 'Êú™Êî∂ÂΩï', icon: '‚ùå' }
                ];

                const getShortTag = (tag) => {
                    const map = {
                        'JavDB TOP250': 'DB',
                        'JavDB 2025 TOP250': 'DB25',
                        'JavDB 2024 TOP250': 'DB24',
                        'JavDB 2023 TOP250': 'DB23',
                        'JavLibray TOP500': 'JL'
                    };
                    return map[tag] || tag;
                };

                const sortMovies = (list) => {
                    if (sortBy.value === 'year_desc') {
                        return [...list].sort((a, b) => (b.year || '').localeCompare(a.year || ''));
                    } else if (sortBy.value === 'year_asc') {
                        return [...list].sort((a, b) => (a.year || '').localeCompare(b.year || ''));
                    }
                    return list;
                };

                const loadMovies = async () => {
                    const res = await axios.get('/api/movies', {
                        params: {
                            search: search.value,
                            page: currentPage.value,
                            page_size: pageSize.value
                        }
                    });
                    movies.value = sortMovies(res.data.data);
                    totalPages.value = res.data.total_pages;
                    totalItems.value = res.data.total;
                };

                const handleSearch = () => {
                    currentPage.value = 1;
                    if (currentTab.value === 'all') {
                        loadMovies();
                    } else if (currentTab.value.startsWith('actor_')) {
                        sortActorMovies();
                    }
                };

                const sortActorMovies = () => {
                    actorMovies.value = sortMovies(actorMovies.value);
                };

                const loadList = async (listName) => {
                    let apiName = listName;
                    if (listName === 'javdb') apiName = 'JavDB TOP250';
                    if (listName === 'javdb_2025') apiName = 'JavDB 2025 TOP250';
                    if (listName === 'javdb_2024') apiName = 'JavDB 2024 TOP250';
                    if (listName === 'javdb_2023') apiName = 'JavDB 2023 TOP250';
                    if (listName === 'javlib') apiName = 'JavLibray TOP500';

                    const res = await axios.get(`/api/list/${encodeURIComponent(apiName)}`, {
                        params: {
                            page: currentPage.value,
                            page_size: pageSize.value
                        }
                    });
                    listMovies.value = res.data.data;
                    totalPages.value = res.data.total_pages;
                    totalItems.value = res.data.total;
                };

                const loadMissing = async () => {
                    const res = await axios.get('/api/list/missing');
                    missing.value = res.data;
                };

                const loadActors = async () => {
                    const res = await axios.get('/api/actors');
                    actors.value = res.data;
                };

                const showActorMovies = async (actorName) => {
                    currentActorName.value = actorName;
                    const res = await axios.get(`/api/actor/${encodeURIComponent(actorName)}`);
                    actorMovies.value = sortMovies(res.data);
                    currentTab.value = 'actor_' + encodeURIComponent(actorName);
                };

                const loadStats = async () => {
                    const res = await axios.get('/api/stats');
                    stats.value = res.data;
                };

                const sync = async () => {
                    syncing.value = true;
                    try {
                        await axios.post('/api/sync');
                        await loadMovies();
                        await loadStats();
                        await switchTab(currentTab.value);
                    } finally {
                        syncing.value = false;
                    }
                };

                const switchTab = async (tabId) => {
                    currentTab.value = tabId;
                    currentPage.value = 1;
                    if (tabId === 'all') {
                        await loadMovies();
                    } else if (tabId === 'missing') {
                        await loadMissing();
                    } else if (tabId === 'actors') {
                        await loadActors();
                    } else if (tabId.startsWith('actor_')) {
                        const actorName = decodeURIComponent(tabId.substring(7));
                        currentActorName.value = actorName;
                        const res = await axios.get(`/api/actor/${encodeURIComponent(actorName)}`);
                        actorMovies.value = sortMovies(res.data);
                    } else {
                        await loadList(tabId);
                    }
                };

                const goToPage = async (page) => {
                    if (page < 1 || page > totalPages.value) return;
                    currentPage.value = page;
                    if (currentTab.value === 'all') {
                        await loadMovies();
                    } else if (currentTab.value.startsWith('javdb') || currentTab.value === 'javlib') {
                        await loadList(currentTab.value);
                    }
                };

                const changePageSize = async (size) => {
                    pageSize.value = size;
                    currentPage.value = 1;
                    if (currentTab.value === 'all') {
                        await loadMovies();
                    } else if (currentTab.value.startsWith('javdb') || currentTab.value === 'javlib') {
                        await loadList(currentTab.value);
                    }
                };

                onMounted(async () => {
                    await loadStats();
                    await loadMovies();
                });

                return {
                    currentTab,
                    movies,
                    listMovies,
                    missing,
                    actors,
                    actorMovies,
                    currentActorName,
                    search,
                    sortBy,
                    syncing,
                    stats,
                    tabs,
                    currentPage,
                    pageSize,
                    totalPages,
                    totalItems,
                    getShortTag,
                    loadMovies,
                    handleSearch,
                    loadActors,
                    showActorMovies,
                    sync,
                    switchTab,
                    goToPage,
                    changePageSize
                };
            }
        });
        
        app.config.compilerOptions.delimiters = ['[[', ']]'];
        app.mount('#app');
    </script>
</body>
</html>
